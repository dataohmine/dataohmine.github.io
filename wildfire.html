<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wildfire Predictor - AI-Powered Risk Assessment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#1E40AF',
                        accent: '#06B6D4',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        success: '#10B981'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fas fa-fire text-red-500 text-2xl mr-3"></i>
                        <span class="text-xl font-bold text-gray-900">Wildfire Predictor</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-gray-900 hover:text-primary transition duration-300">← Back to Portfolio</a>
                    <button id="refreshData" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition duration-300">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Alert Banner -->
    <div id="alertBanner" class="hidden bg-red-600 text-white py-2 px-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span id="alertText">High wildfire risk detected in your area!</span>
            </div>
            <button onclick="document.getElementById('alertBanner').classList.add('hidden')" class="text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">AI-Powered Wildfire Risk Assessment</h1>
            <p class="text-gray-600">Real-time wildfire prediction and risk analysis for Ventura County with interactive zone monitoring</p>
        </div>

        <!-- AI Chat Assistant - Moved Higher for Better UX -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-robot text-primary mr-3"></i>AI Fire Safety Assistant
                </h2>
                <div class="flex space-x-2">
                    <button onclick="askQuickQuestion('What is the current risk level?')" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm hover:bg-blue-200 transition">Current Risk</button>
                    <button onclick="askQuickQuestion('What should I do if I see smoke?')" class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm hover:bg-red-200 transition">Emergency</button>
                    <button onclick="askQuickQuestion('How can I protect my home?')" class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm hover:bg-green-200 transition">Prevention</button>
                    <button onclick="toggleApiSettings()" class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition" title="Configure AI API">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
            
            <div id="chatHistory" class="bg-gray-50 rounded-lg p-4 h-40 overflow-y-auto mb-4 space-y-2">
                <div class="flex items-start space-x-2">
                    <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm flex-1">
                        <p class="text-sm text-gray-800">Hello! I'm your AI wildfire safety assistant. I can provide real-time risk updates, emergency guidance, and prevention tips. What would you like to know?</p>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-2">
                <input 
                    type="text" 
                    id="chatInput" 
                    placeholder="Ask about fire safety, current risks, or prevention tips..."
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    onkeypress="handleChatKeyPress(event)"
                />
                <button onclick="sendChatMessage()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-secondary transition duration-300">
                    <i class="fas fa-paper-plane mr-2"></i>Send
                </button>
            </div>
            
            <!-- API Settings Panel (Hidden by default) -->
            <div id="apiSettings" class="hidden mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-900">AI API Configuration</h3>
                    <button onclick="toggleApiSettings()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">OpenAI API Key (for enhanced responses)</label>
                        <input 
                            type="password" 
                            id="openaiKey" 
                            placeholder="sk-..." 
                            class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            value="${localStorage.getItem('openai_api_key') || ''}"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Anthropic API Key (alternative)</label>
                        <input 
                            type="password" 
                            id="anthropicKey" 
                            placeholder="sk-ant-..." 
                            class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            value="${localStorage.getItem('anthropic_api_key') || ''}"
                        />
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="saveApiKeys()" class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 transition">
                            <i class="fas fa-save mr-1"></i>Save
                        </button>
                        <button onclick="clearApiKeys()" class="bg-red-600 text-white px-4 py-2 rounded text-sm hover:bg-red-700 transition">
                            <i class="fas fa-trash mr-1"></i>Clear
                        </button>
                    </div>
                    <p class="text-xs text-gray-600">
                        ⚡ API keys enable real-time AI analysis. Without keys, intelligent fallback responses are used. 
                        Keys are stored locally and never shared.
                    </p>
                </div>
            </div>
        </div>

        <!-- Interactive ZIP Code Risk Grid - Enhanced Version -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-map-marked-alt text-primary mr-3"></i>Interactive Risk Zones - Ventura County
                </h2>
                <div class="flex items-center space-x-4 text-sm">
                    <div class="flex items-center">
                        <i class="fas fa-thermometer-half text-red-500 mr-1"></i>
                        <span id="currentTemp">89°F</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-wind text-gray-500 mr-1"></i>
                        <span id="currentWind">18 mph</span>
                    </div>
                    <div class="px-3 py-1 bg-orange-100 text-orange-800 rounded text-xs font-medium">
                        FWI: <span id="fireWeatherIndex">82</span>/100
                    </div>
                    <div class="text-xs text-gray-500" id="lastUpdated">Updated: 2 min ago</div>
                </div>
            </div>
            
            <!-- ZIP Code Risk Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="zipCodeGrid">
                <!-- ZIP codes will be dynamically generated -->
            </div>
            
            <!-- Risk Legend -->
            <div class="flex items-center justify-center space-x-8 mt-6 text-sm border-t pt-4">
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                    <span>Low Risk (0-35)</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-yellow-500 rounded-full mr-2"></div>
                    <span>Moderate (35-60)</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-orange-500 rounded-full mr-2"></div>
                    <span>High (60-80)</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-red-500 rounded-full mr-2"></div>
                    <span>Extreme (80+)</span>
                </div>
                <div class="flex items-center ml-8">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse mr-2"></div>
                    <span class="text-xs">Live Monitoring</span>
                </div>
            </div>
        </div>

        <!-- Enhanced Real-Time Weather & Risk Factors -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Temperature -->
            <div class="bg-white rounded-xl shadow-lg p-6 text-center relative overflow-hidden">
                <div class="absolute top-2 right-2">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                </div>
                <div class="text-3xl mb-2">🌡️</div>
                <h3 class="font-semibold text-gray-900 mb-2">Temperature</h3>
                
                <div class="mb-3">
                    <div class="text-2xl font-bold text-red-600 mb-1" id="tempRisk">HIGH</div>
                    <div class="text-lg text-gray-700" id="temperature">87°F</div>
                </div>
                
                <!-- Animated Temperature Bar -->
                <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                    <div class="bg-gradient-to-r from-blue-400 via-yellow-400 to-red-500 h-2 rounded-full transition-all duration-1000 ease-in-out" 
                         id="tempProgress" style="width: 70%"></div>
                </div>
                
                <div class="flex items-center justify-center text-xs text-gray-500 mb-1">
                    <span id="tempTrend" class="flex items-center">
                        <i class="fas fa-arrow-up text-red-500 mr-1"></i>Rising
                    </span>
                </div>
                <p class="text-sm text-gray-600">Above 85°F increases risk</p>
            </div>

            <!-- Humidity -->
            <div class="bg-white rounded-xl shadow-lg p-6 text-center relative overflow-hidden">
                <div class="absolute top-2 right-2">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                </div>
                <div class="text-3xl mb-2">💧</div>
                <h3 class="font-semibold text-gray-900 mb-2">Humidity</h3>
                
                <div class="mb-3">
                    <div class="text-2xl font-bold text-red-600 mb-1" id="humidityRisk">CRITICAL</div>
                    <div class="text-lg text-gray-700" id="humidity">15%</div>
                </div>
                
                <!-- Animated Humidity Bar (inverted - lower is more dangerous) -->
                <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                    <div class="bg-gradient-to-r from-red-500 via-orange-400 to-blue-500 h-2 rounded-full transition-all duration-1000 ease-in-out" 
                         id="humidityProgress" style="width: 15%"></div>
                </div>
                
                <div class="flex items-center justify-center text-xs text-red-500 mb-1">
                    <span id="humidityTrend" class="flex items-center">
                        <i class="fas fa-exclamation-triangle mr-1"></i>Critical
                    </span>
                </div>
                <p class="text-sm text-gray-600">Below 20% is dangerous</p>
            </div>

            <!-- Wind -->
            <div class="bg-white rounded-xl shadow-lg p-6 text-center relative overflow-hidden">
                <div class="absolute top-2 right-2">
                    <div class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>
                </div>
                <div class="relative mb-2">
                    <div class="text-3xl">💨</div>
                    <div class="absolute top-0 right-4 text-sm">
                        <i class="fas fa-location-arrow text-purple-600 transform rotate-45 animate-spin" 
                           style="animation: spin 4s linear infinite;" id="windDirection"></i>
                    </div>
                </div>
                <h3 class="font-semibold text-gray-900 mb-2">Wind</h3>
                
                <div class="mb-3">
                    <div class="text-2xl font-bold text-orange-600 mb-1" id="windRisk">MODERATE</div>
                    <div class="text-lg text-gray-700" id="windSpeed">25 mph</div>
                </div>
                
                <!-- Animated Wind Bar -->
                <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                    <div class="bg-gradient-to-r from-green-400 via-yellow-400 to-red-500 h-2 rounded-full transition-all duration-1000 ease-in-out" 
                         id="windProgress" style="width: 50%"></div>
                </div>
                
                <div class="flex items-center justify-center text-xs text-gray-500 mb-1">
                    <span id="windTrend" class="flex items-center">
                        <i class="fas fa-compass text-purple-600 mr-1"></i>SW • Gusting
                    </span>
                </div>
                <p class="text-sm text-gray-600">Speed and direction matter</p>
            </div>

            <!-- Enhanced Vegetation with Fire Weather Index -->
            <div class="bg-white rounded-xl shadow-lg p-6 text-center relative overflow-hidden">
                <div class="absolute top-2 right-2">
                    <div class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>
                </div>
                <div class="text-3xl mb-2">🔥</div>
                <h3 class="font-semibold text-gray-900 mb-2">Fire Weather Index</h3>
                
                <div class="mb-3">
                    <div class="text-2xl font-bold text-red-600 mb-1" id="fwiRisk">HIGH</div>
                    <div class="text-lg text-gray-700" id="fwiValue">78/100</div>
                </div>
                
                <!-- Animated FWI Bar -->
                <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                    <div class="bg-gradient-to-r from-green-400 via-orange-400 to-red-500 h-2 rounded-full transition-all duration-1000 ease-in-out" 
                         id="fwiProgress" style="width: 78%"></div>
                </div>
                
                <div class="flex items-center justify-center text-xs text-red-500 mb-1">
                    <span id="fwiTrend" class="flex items-center">
                        <i class="fas fa-fire text-red-500 mr-1"></i>Elevated
                    </span>
                </div>
                <p class="text-sm text-gray-600">Combined risk assessment</p>
            </div>
        </div>

        <!-- Historical Data Chart -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-900">7-Day Risk Trend</h2>
                <div class="flex space-x-2">
                    <button class="px-3 py-1 bg-primary text-white rounded text-sm">7D</button>
                    <button class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm">30D</button>
                    <button class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm">90D</button>
                    <button onclick="createRiskChart()" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700" title="Reload Chart">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
            </div>
            <div class="relative">
                <canvas id="riskChart" width="800" height="300"></canvas>
            </div>
        </div>

        <!-- AI Insights -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center mb-4">
                <i class="fas fa-robot text-primary text-2xl mr-3"></i>
                <h2 class="text-xl font-semibold text-gray-900">AI Analysis & Recommendations</h2>
            </div>
            <div id="aiInsights" class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                <div class="flex items-start">
                    <i class="fas fa-lightbulb text-blue-600 text-lg mr-3 mt-1"></i>
                    <div>
                        <h4 class="font-semibold text-blue-900 mb-2">Current Assessment</h4>
                        <p class="text-blue-800 mb-3">Based on current weather conditions and historical patterns, wildfire risk is elevated in Ventura County. The combination of high temperatures (87°F), low humidity (15%), and moderate winds (25 mph) creates favorable conditions for fire ignition and spread.</p>
                        
                        <h4 class="font-semibold text-blue-900 mb-2">Recommendations</h4>
                        <ul class="text-blue-800 space-y-1">
                            <li>• Avoid outdoor burning or activities that could create sparks</li>
                            <li>• Maintain defensible space around structures</li>
                            <li>• Keep emergency evacuation plans readily available</li>
                            <li>• Monitor local emergency alerts and weather updates</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Location-Specific Alerts -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Area-Specific Alerts</h2>
            
            <div class="space-y-4">
                <div class="flex items-center p-4 bg-red-50 border-l-4 border-red-400 rounded">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl mr-4"></i>
                    <div class="flex-1">
                        <h4 class="font-semibold text-red-900">Simi Valley - HIGH RISK</h4>
                        <p class="text-red-800">Extreme fire weather conditions. Red Flag Warning in effect.</p>
                    </div>
                    <span class="text-sm text-red-600">Active</span>
                </div>

                <div class="flex items-center p-4 bg-orange-50 border-l-4 border-orange-400 rounded">
                    <i class="fas fa-fire text-orange-600 text-xl mr-4"></i>
                    <div class="flex-1">
                        <h4 class="font-semibold text-orange-900">Thousand Oaks - MODERATE RISK</h4>
                        <p class="text-orange-800">Elevated conditions due to Santa Ana winds.</p>
                    </div>
                    <span class="text-sm text-orange-600">Monitoring</span>
                </div>

                <div class="flex items-center p-4 bg-green-50 border-l-4 border-green-400 rounded">
                    <i class="fas fa-check-circle text-green-600 text-xl mr-4"></i>
                    <div class="flex-1">
                        <h4 class="font-semibold text-green-900">Oxnard - LOW RISK</h4>
                        <p class="text-green-800">Coastal marine layer providing protection.</p>
                    </div>
                    <span class="text-sm text-green-600">Normal</span>
                </div>
            </div>
        </div>

        <!-- Interactive Risk Map -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-900">Interactive Risk Map - Ventura County</h2>
                <button onclick="initializeMap()" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700" title="Reload Map">
                    <i class="fas fa-redo mr-1"></i>Reload Map
                </button>
            </div>
            <div id="map" style="height: 400px; width: 100%;" class="rounded-lg border border-gray-200"></div>
            <div class="mt-4 flex flex-wrap gap-4">
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-red-500 rounded-full mr-2"></div>
                    <span class="text-sm text-gray-600">High Risk Areas</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-orange-500 rounded-full mr-2"></div>
                    <span class="text-sm text-gray-600">Moderate Risk</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                    <span class="text-sm text-gray-600">Low Risk</span>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Enhanced Ventura County ZIP code data with detailed risk analysis
        const venturaZipCodes = [
            { zipCode: '93001', name: 'Ventura', lat: 34.2697, lon: -119.2313, risk: 73, level: 'HIGH', temp: 89, humidity: 22, wind: 18 },
            { zipCode: '93003', name: 'Ventura East', lat: 34.2566, lon: -119.2070, risk: 68, level: 'HIGH', temp: 87, humidity: 24, wind: 16 },
            { zipCode: '93004', name: 'Ventura West', lat: 34.2775, lon: -119.2971, risk: 45, level: 'MODERATE', temp: 82, humidity: 35, wind: 12 },
            { zipCode: '93010', name: 'Camarillo', lat: 34.2164, lon: -119.0376, risk: 62, level: 'HIGH', temp: 86, humidity: 28, wind: 14 },
            { zipCode: '93021', name: 'Moorpark', lat: 34.2855, lon: -118.8826, risk: 55, level: 'MODERATE', temp: 84, humidity: 32, wind: 11 },
            { zipCode: '93023', name: 'Ojai', lat: 34.4481, lon: -119.2429, risk: 81, level: 'EXTREME', temp: 92, humidity: 18, wind: 22 },
            { zipCode: '93030', name: 'Oxnard', lat: 34.1975, lon: -119.1771, risk: 39, level: 'MODERATE', temp: 79, humidity: 42, wind: 9 },
            { zipCode: '93063', name: 'Simi Valley', lat: 34.2694, lon: -118.7815, risk: 58, level: 'MODERATE', temp: 85, humidity: 30, wind: 13 },
            { zipCode: '91361', name: 'Thousand Oaks', lat: 34.1706, lon: -118.8375, risk: 51, level: 'MODERATE', temp: 83, humidity: 33, wind: 10 },
        ];
        
        let selectedZipCode = '';

        // Simulated real-time data
        let currentRiskScore = 75;
        let weatherData = {
            temperature: 87,
            humidity: 15,
            windSpeed: 25,
            visibility: 8
        };
        
        // Enhanced risk color function
        function getRiskColor(riskLevel) {
            if (riskLevel >= 80) return '#DC2626'; // Red - Extreme
            if (riskLevel >= 60) return '#EA580C'; // Orange - High  
            if (riskLevel >= 35) return '#CA8A04'; // Yellow - Moderate
            return '#16A34A'; // Green - Low
        }
        
        // Populate ZIP code grid
        function populateZipCodeGrid() {
            const gridContainer = document.getElementById('zipCodeGrid');
            if (!gridContainer) return;
            
            gridContainer.innerHTML = '';
            
            venturaZipCodes.forEach((zip, index) => {
                const zipCard = document.createElement('div');
                zipCard.className = `
                    relative bg-white rounded-lg shadow-lg p-4 cursor-pointer transition-all duration-300 hover:scale-105 border-2
                    ${selectedZipCode === zip.zipCode ? 'ring-4 ring-blue-500 shadow-2xl border-blue-300' : 'hover:shadow-xl border-transparent'}
                `;
                zipCard.style.borderTop = `4px solid ${getRiskColor(zip.risk)}`;
                zipCard.onclick = () => selectZipCode(zip.zipCode);
                
                zipCard.innerHTML = `
                    <!-- Risk Level Indicator -->
                    <div
                        class="absolute top-2 right-2 w-6 h-6 rounded-full opacity-80"
                        style="background-color: ${getRiskColor(zip.risk)}"
                        title="${zip.level} Risk"
                    ></div>

                    <!-- ZIP Code Info -->
                    <div class="mb-3">
                        <div class="font-bold text-lg text-gray-900">${zip.zipCode}</div>
                        <div class="text-sm text-gray-600">${zip.name}</div>
                    </div>

                    <!-- Risk Score -->
                    <div class="mb-3">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-500">Risk Score</span>
                            <span class="font-bold text-lg" style="color: ${getRiskColor(zip.risk)}">
                                ${zip.risk}/100
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                            <div
                                class="h-2 rounded-full transition-all duration-500"
                                style="
                                    width: ${zip.risk}%;
                                    background-color: ${getRiskColor(zip.risk)}
                                "
                            ></div>
                        </div>
                    </div>

                    <!-- Weather Conditions -->
                    <div class="space-y-2 text-xs text-gray-600">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-thermometer-half text-red-500 mr-1 text-xs"></i>
                                <span>Temp</span>
                            </div>
                            <span>${zip.temp}°F</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-1"></div>
                                <span>Humidity</span>
                            </div>
                            <span>${zip.humidity}%</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-wind text-gray-500 mr-1 text-xs"></i>
                                <span>Wind</span>
                            </div>
                            <span>${zip.wind} mph</span>
                        </div>
                    </div>

                    <!-- Risk Level Badge -->
                    <div class="
                        absolute bottom-2 right-2 px-2 py-1 rounded text-xs font-medium
                        ${zip.level === 'EXTREME' ? 'bg-red-100 text-red-800' :
                          zip.level === 'HIGH' ? 'bg-orange-100 text-orange-800' :
                          zip.level === 'MODERATE' ? 'bg-yellow-100 text-yellow-800' :
                          'bg-green-100 text-green-800'}
                    ">
                        ${zip.level}
                    </div>
                `;
                
                gridContainer.appendChild(zipCard);
            });
        }
        
        // Select ZIP code function
        function selectZipCode(zipCode) {
            selectedZipCode = zipCode;
            const selectedZip = venturaZipCodes.find(zip => zip.zipCode === zipCode);
            
            if (selectedZip) {
                // Update header weather data to show selected ZIP's data
                document.getElementById('currentTemp').textContent = `${selectedZip.temp}°F`;
                document.getElementById('currentWind').textContent = `${selectedZip.wind} mph`;
                
                // Show selected ZIP details in chat
                const detailMessage = `Selected ${selectedZip.name} (${selectedZip.zipCode}): ${selectedZip.level} risk (${selectedZip.risk}/100). Current conditions: ${selectedZip.temp}°F, ${selectedZip.humidity}% humidity, ${selectedZip.wind} mph winds.`;
                addChatMessage(detailMessage, 'ai');
            }
            
            // Re-render grid to show selection
            populateZipCodeGrid();
        }

        // Initialize dashboard
        function initializeDashboard() {
            updateRiskGauge();
            updateWeatherData();
            updateRiskFactors();
            createRiskChart();
            populateZipCodeGrid();
            
            // Show alert if risk is high
            if (currentRiskScore >= 70) {
                showAlert();
            }
            
            // Update timestamp
            updateTimestamp();
        }

        // Update risk gauge
        function updateRiskGauge() {
            const canvas = document.getElementById('riskGauge');
            if (!canvas) {
                console.log('Risk gauge canvas not found - skipping gauge update');
                return;
            }
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 80;

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw background arc
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, Math.PI, 2 * Math.PI);
            ctx.lineWidth = 20;
            ctx.strokeStyle = '#e5e7eb';
            ctx.stroke();

            // Draw risk arc
            const riskAngle = Math.PI + (currentRiskScore / 100) * Math.PI;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, Math.PI, riskAngle);
            ctx.lineWidth = 20;
            
            if (currentRiskScore < 30) {
                ctx.strokeStyle = '#10B981'; // Green
            } else if (currentRiskScore < 70) {
                ctx.strokeStyle = '#F59E0B'; // Orange
            } else {
                ctx.strokeStyle = '#EF4444'; // Red
            }
            ctx.stroke();

            // Update text elements if they exist
            const riskScoreEl = document.getElementById('riskScore');
            if (riskScoreEl) {
                riskScoreEl.textContent = currentRiskScore;
            }
            
            let riskLevel, riskDescription;
            if (currentRiskScore < 30) {
                riskLevel = 'LOW';
                riskDescription = 'Current conditions pose minimal wildfire risk.';
            } else if (currentRiskScore < 70) {
                riskLevel = 'MODERATE';
                riskDescription = 'Be aware of fire conditions and exercise normal precautions.';
            } else {
                riskLevel = 'HIGH';
                riskDescription = 'Elevated wildfire conditions detected. Exercise caution in high-risk areas.';
            }
            
            const riskLevelEl = document.getElementById('riskLevel');
            if (riskLevelEl) {
                riskLevelEl.textContent = riskLevel;
                riskLevelEl.className = `text-lg font-semibold ${currentRiskScore < 30 ? 'text-green-600' : currentRiskScore < 70 ? 'text-orange-600' : 'text-red-600'}`;
            }
            
            const riskDescriptionEl = document.getElementById('riskDescription');
            if (riskDescriptionEl) {
                riskDescriptionEl.textContent = riskDescription;
            }
        }

        // Enhanced weather data update with animations
        function updateWeatherData() {
            // Update temperature
            const temp = weatherData.temperature;
            document.getElementById('temperature').textContent = temp + '°F';
            
            // Update temperature progress bar (scaled from 60-110°F range)
            const tempProgress = Math.min(100, Math.max(0, ((temp - 60) / 50) * 100));
            document.getElementById('tempProgress').style.width = tempProgress + '%';
            
            // Update humidity
            const humidity = weatherData.humidity;
            document.getElementById('humidity').textContent = humidity + '%';
            document.getElementById('humidityProgress').style.width = humidity + '%';
            
            // Update wind speed
            const windSpeed = weatherData.windSpeed;
            document.getElementById('windSpeed').textContent = windSpeed + ' mph';
            
            // Update wind progress bar (scaled to 50 mph max)
            const windProgress = Math.min(100, (windSpeed / 50) * 100);
            document.getElementById('windProgress').style.width = windProgress + '%';
            
            // Update Fire Weather Index
            const fwi = Math.round(currentRiskScore * 1.2); // Convert risk score to FWI scale
            document.getElementById('fwiValue').textContent = Math.min(100, fwi) + '/100';
            document.getElementById('fwiProgress').style.width = Math.min(100, fwi) + '%';
            
            // Update trends and direction indicators
            updateWeatherTrends(temp, humidity, windSpeed);
            
            // Legacy visibility update if element exists
            const visibilityEl = document.getElementById('visibility');
            if (visibilityEl) {
                visibilityEl.textContent = weatherData.visibility + ' miles';
            }
        }
        
        // Update weather trend indicators
        function updateWeatherTrends(temp, humidity, windSpeed) {
            // Temperature trend
            const tempTrend = document.getElementById('tempTrend');
            if (temp > 85) {
                tempTrend.innerHTML = '<i class="fas fa-arrow-up text-red-500 mr-1"></i>Rising - Critical';
                tempTrend.className = 'flex items-center text-red-500';
            } else if (temp > 75) {
                tempTrend.innerHTML = '<i class="fas fa-arrow-up text-orange-500 mr-1"></i>Elevated';
                tempTrend.className = 'flex items-center text-orange-500';
            } else {
                tempTrend.innerHTML = '<i class="fas fa-thermometer-empty text-green-500 mr-1"></i>Normal';
                tempTrend.className = 'flex items-center text-green-500';
            }
            
            // Humidity trend
            const humidityTrend = document.getElementById('humidityTrend');
            if (humidity < 20) {
                humidityTrend.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>Critical';
                humidityTrend.className = 'flex items-center text-red-500';
            } else if (humidity < 40) {
                humidityTrend.innerHTML = '<i class="fas fa-exclamation text-orange-500 mr-1"></i>Low';
                humidityTrend.className = 'flex items-center text-orange-500';
            } else {
                humidityTrend.innerHTML = '<i class="fas fa-check text-green-500 mr-1"></i>Adequate';
                humidityTrend.className = 'flex items-center text-green-500';
            }
            
            // Wind trend with direction
            const windTrend = document.getElementById('windTrend');
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const windDir = directions[Math.floor(Math.random() * 8)]; // Simulated wind direction
            
            if (windSpeed > 25) {
                windTrend.innerHTML = `<i class="fas fa-wind text-red-500 mr-1"></i>${windDir} • High`;
                windTrend.className = 'flex items-center text-red-500';
            } else if (windSpeed > 15) {
                windTrend.innerHTML = `<i class="fas fa-compass text-orange-500 mr-1"></i>${windDir} • Moderate`;
                windTrend.className = 'flex items-center text-orange-500';
            } else {
                windTrend.innerHTML = `<i class="fas fa-leaf text-green-500 mr-1"></i>${windDir} • Light`;
                windTrend.className = 'flex items-center text-green-500';
            }
            
            // Update spinning wind direction indicator
            const windDirectionEl = document.getElementById('windDirection');
            const rotation = Math.floor(Math.random() * 360);
            windDirectionEl.style.transform = `rotate(${rotation}deg)`;
            
            // Fire Weather Index trend
            const fwiTrend = document.getElementById('fwiTrend');
            const fwi = Math.round(currentRiskScore * 1.2);
            
            if (fwi > 80) {
                fwiTrend.innerHTML = '<i class="fas fa-fire text-red-500 mr-1"></i>Extreme';
                fwiTrend.className = 'flex items-center text-red-500';
            } else if (fwi > 60) {
                fwiTrend.innerHTML = '<i class="fas fa-flame text-orange-500 mr-1"></i>High';
                fwiTrend.className = 'flex items-center text-orange-500';
            } else if (fwi > 40) {
                fwiTrend.innerHTML = '<i class="fas fa-fire-alt text-yellow-500 mr-1"></i>Moderate';
                fwiTrend.className = 'flex items-center text-yellow-500';
            } else {
                fwiTrend.innerHTML = '<i class="fas fa-check-circle text-green-500 mr-1"></i>Low';
                fwiTrend.className = 'flex items-center text-green-500';
            }
        }

        // Enhanced risk factors with advanced color coding
        function updateRiskFactors() {
            const temp = weatherData.temperature;
            const humidity = weatherData.humidity;
            const windSpeed = weatherData.windSpeed;
            const fwi = Math.min(100, Math.round(currentRiskScore * 1.2));
            
            // Temperature risk assessment
            let tempRisk, tempColor, tempBgColor;
            if (temp > 95) {
                tempRisk = 'EXTREME';
                tempColor = 'text-red-800';
                tempBgColor = 'bg-red-100 border-red-200';
            } else if (temp > 85) {
                tempRisk = 'HIGH';
                tempColor = 'text-red-600';
                tempBgColor = 'bg-red-50 border-red-200';
            } else if (temp > 75) {
                tempRisk = 'MODERATE';
                tempColor = 'text-orange-600';
                tempBgColor = 'bg-orange-50 border-orange-200';
            } else {
                tempRisk = 'LOW';
                tempColor = 'text-green-600';
                tempBgColor = 'bg-green-50 border-green-200';
            }
            
            // Humidity risk assessment (lower humidity = higher risk)
            let humidityRisk, humidityColor, humidityBgColor;
            if (humidity < 15) {
                humidityRisk = 'EXTREME';
                humidityColor = 'text-red-800';
                humidityBgColor = 'bg-red-100 border-red-200';
            } else if (humidity < 25) {
                humidityRisk = 'CRITICAL';
                humidityColor = 'text-red-600';
                humidityBgColor = 'bg-red-50 border-red-200';
            } else if (humidity < 40) {
                humidityRisk = 'HIGH';
                humidityColor = 'text-orange-600';
                humidityBgColor = 'bg-orange-50 border-orange-200';
            } else {
                humidityRisk = 'MODERATE';
                humidityColor = 'text-yellow-600';
                humidityBgColor = 'bg-yellow-50 border-yellow-200';
            }
            
            // Wind risk assessment
            let windRisk, windColor, windBgColor;
            if (windSpeed > 35) {
                windRisk = 'EXTREME';
                windColor = 'text-red-800';
                windBgColor = 'bg-red-100 border-red-200';
            } else if (windSpeed > 25) {
                windRisk = 'HIGH';
                windColor = 'text-red-600';
                windBgColor = 'bg-red-50 border-red-200';
            } else if (windSpeed > 15) {
                windRisk = 'MODERATE';
                windColor = 'text-orange-600';
                windBgColor = 'bg-orange-50 border-orange-200';
            } else {
                windRisk = 'LOW';
                windColor = 'text-green-600';
                windBgColor = 'bg-green-50 border-green-200';
            }
            
            // Fire Weather Index risk assessment
            let fwiRisk, fwiColor, fwiBgColor;
            if (fwi > 85) {
                fwiRisk = 'EXTREME';
                fwiColor = 'text-red-800';
                fwiBgColor = 'bg-red-100 border-red-200';
            } else if (fwi > 70) {
                fwiRisk = 'HIGH';
                fwiColor = 'text-red-600';
                fwiBgColor = 'bg-red-50 border-red-200';
            } else if (fwi > 50) {
                fwiRisk = 'MODERATE';
                fwiColor = 'text-orange-600';
                fwiBgColor = 'bg-orange-50 border-orange-200';
            } else {
                fwiRisk = 'LOW';
                fwiColor = 'text-green-600';
                fwiBgColor = 'bg-green-50 border-green-200';
            }
            
            // Update risk labels and colors
            const tempRiskEl = document.getElementById('tempRisk');
            if (tempRiskEl) {
                tempRiskEl.textContent = tempRisk;
                tempRiskEl.className = `text-2xl font-bold mb-1 ${tempColor}`;
                
                // Add visual glow effect for high risk
                if (tempRisk === 'EXTREME' || tempRisk === 'HIGH') {
                    tempRiskEl.parentElement.parentElement.classList.add('ring-2', 'ring-red-200', 'shadow-lg');
                } else {
                    tempRiskEl.parentElement.parentElement.classList.remove('ring-2', 'ring-red-200', 'shadow-lg');
                }
            }
            
            const humidityRiskEl = document.getElementById('humidityRisk');
            if (humidityRiskEl) {
                humidityRiskEl.textContent = humidityRisk;
                humidityRiskEl.className = `text-2xl font-bold mb-1 ${humidityColor}`;
                
                // Add visual emphasis for critical humidity
                if (humidityRisk === 'EXTREME' || humidityRisk === 'CRITICAL') {
                    humidityRiskEl.parentElement.parentElement.classList.add('ring-2', 'ring-red-200', 'shadow-lg');
                } else {
                    humidityRiskEl.parentElement.parentElement.classList.remove('ring-2', 'ring-red-200', 'shadow-lg');
                }
            }
            
            const windRiskEl = document.getElementById('windRisk');
            if (windRiskEl) {
                windRiskEl.textContent = windRisk;
                windRiskEl.className = `text-2xl font-bold mb-1 ${windColor}`;
                
                // Add visual emphasis for high wind risk
                if (windRisk === 'EXTREME' || windRisk === 'HIGH') {
                    windRiskEl.parentElement.parentElement.classList.add('ring-2', 'ring-orange-200', 'shadow-lg');
                } else {
                    windRiskEl.parentElement.parentElement.classList.remove('ring-2', 'ring-orange-200', 'shadow-lg');
                }
            }
            
            const fwiRiskEl = document.getElementById('fwiRisk');
            if (fwiRiskEl) {
                fwiRiskEl.textContent = fwiRisk;
                fwiRiskEl.className = `text-2xl font-bold mb-1 ${fwiColor}`;
                
                // Add visual emphasis for high FWI risk
                if (fwiRisk === 'EXTREME' || fwiRisk === 'HIGH') {
                    fwiRiskEl.parentElement.parentElement.classList.add('ring-2', 'ring-red-200', 'shadow-lg');
                } else {
                    fwiRiskEl.parentElement.parentElement.classList.remove('ring-2', 'ring-red-200', 'shadow-lg');
                }
            }
            
            // Update overall page styling based on highest risk level
            updateOverallRiskStyling(tempRisk, humidityRisk, windRisk, fwiRisk);
        }
        
        // Update overall page styling based on risk levels
        function updateOverallRiskStyling(tempRisk, humidityRisk, windRisk, fwiRisk) {
            const risks = [tempRisk, humidityRisk, windRisk, fwiRisk];
            const hasExtreme = risks.includes('EXTREME');
            const hasCritical = risks.includes('CRITICAL') || risks.includes('HIGH');
            
            const body = document.body;
            const header = document.querySelector('header');
            
            // Reset classes
            body.classList.remove('bg-red-25', 'bg-orange-25', 'bg-yellow-25');
            
            // Apply overall theme based on highest risk
            if (hasExtreme) {
                body.classList.add('bg-red-25');
                if (header) {
                    header.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
                }
                
                // Add pulsing effect to high-risk elements
                const pulsingElements = document.querySelectorAll('.ring-2');
                pulsingElements.forEach(el => {
                    el.style.animation = 'pulse 2s infinite';
                });
            } else if (hasCritical) {
                body.classList.add('bg-orange-25');
                if (header) {
                    header.style.background = 'linear-gradient(135deg, #fed7aa 0%, #fdba74 100%)';
                }
            } else {
                if (header) {
                    header.style.background = 'linear-gradient(135deg, #3B82F6, #1E40AF)';
                }
            }
        }

        // Create risk trend chart
        function createRiskChart() {
            const chartCanvas = document.getElementById('riskChart');
            if (!chartCanvas) {
                console.error('Risk chart canvas not found');
                return;
            }
            
            const ctx = chartCanvas.getContext('2d');
            
            // Generate sample historical data
            const labels = [];
            const data = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                data.push(Math.floor(Math.random() * 40) + 40 + (i === 0 ? currentRiskScore - 60 : 0));
            }

            try {
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js library not loaded');
                    // Show fallback message
                    const fallbackDiv = document.createElement('div');
                    fallbackDiv.className = 'flex items-center justify-center h-64 text-gray-500';
                    fallbackDiv.innerHTML = '📊 Chart loading... Please refresh if chart doesn\'t appear.';
                    chartCanvas.parentElement.appendChild(fallbackDiv);
                    return;
                }
                
                console.log('Creating Chart.js chart...');
                const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Wildfire Risk Score',
                        data: data,
                        borderColor: '#EF4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: '#e5e7eb'
                            }
                        },
                        x: {
                            grid: {
                                color: '#e5e7eb'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
                console.log('Chart created successfully');
            } catch (error) {
                console.error('Error creating risk chart:', error);
                // Show error fallback
                const errorDiv = document.createElement('div');
                errorDiv.className = 'flex items-center justify-center h-64 text-red-500 bg-red-50 border border-red-200 rounded';
                errorDiv.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <div>Chart could not load</div>
                        <div class="text-sm text-gray-600">Error: ${error.message}</div>
                    </div>
                `;
                chartCanvas.parentElement.appendChild(errorDiv);
                chartCanvas.style.display = 'none';
            }
        }

        // Show alert banner
        function showAlert() {
            document.getElementById('alertBanner').classList.remove('hidden');
        }

        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = `Last updated: ${now.toLocaleTimeString()}`;
        }

        // Simulate data refresh
        function refreshData() {
            // Simulate new data
            currentRiskScore = Math.floor(Math.random() * 40) + 40;
            weatherData.temperature = Math.floor(Math.random() * 20) + 75;
            weatherData.humidity = Math.floor(Math.random() * 25) + 10;
            weatherData.windSpeed = Math.floor(Math.random() * 20) + 10;
            weatherData.visibility = Math.floor(Math.random() * 5) + 5;

            // Update dashboard
            updateRiskGauge();
            updateWeatherData();
            updateRiskFactors();
            updateTimestamp();

            // Show refresh animation
            const button = document.getElementById('refreshData');
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Refreshing...';
            
            setTimeout(() => {
                button.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Refresh Data';
            }, 1000);
        }

        // Initialize Map
        function initializeMap() {
            const mapContainer = document.getElementById('map');
            if (!mapContainer) {
                console.error('Map container not found');
                return;
            }
            
            try {
                if (typeof L === 'undefined') {
                    console.error('Leaflet library not loaded');
                    // Show fallback message
                    const fallbackDiv = document.createElement('div');
                    fallbackDiv.className = 'flex items-center justify-center h-96 text-gray-500 bg-gray-50 border border-gray-200 rounded';
                    fallbackDiv.innerHTML = '🗺️ Map loading... Please refresh if map doesn\'t appear.';
                    mapContainer.appendChild(fallbackDiv);
                    return;
                }
                
                console.log('Creating Leaflet map...');
                // Initialize the map centered on Ventura County
                const map = L.map('map').setView([34.2804, -119.2945], 10);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
            
            // Add risk zone markers
            const riskZones = [
                { lat: 34.2694, lng: -118.7815, risk: 'high', name: 'Simi Valley', description: 'Extreme fire weather conditions' },
                { lat: 34.1808, lng: -118.8398, risk: 'moderate', name: 'Thousand Oaks', description: 'Elevated conditions due to Santa Ana winds' },
                { lat: 34.1975, lng: -119.1771, risk: 'low', name: 'Oxnard', description: 'Coastal marine layer providing protection' },
                { lat: 34.3631, lng: -119.0877, risk: 'high', name: 'Ojai', description: 'Dry mountain conditions' },
                { lat: 34.2804, lng: -119.2945, risk: 'moderate', name: 'Ventura', description: 'Mixed coastal and inland conditions' }
            ];
            
            riskZones.forEach(zone => {
                const color = zone.risk === 'high' ? 'red' : zone.risk === 'moderate' ? 'orange' : 'green';
                const marker = L.circleMarker([zone.lat, zone.lng], {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.6,
                    radius: 8
                }).addTo(map);
                
                marker.bindPopup(`
                    <div class="p-2">
                        <h3 class="font-semibold text-gray-900">${zone.name}</h3>
                        <p class="text-sm text-gray-600 capitalize">${zone.risk} Risk</p>
                        <p class="text-xs text-gray-500">${zone.description}</p>
                    </div>
                `);
            });
            
                console.log('Map initialized successfully');
            } catch (error) {
                console.error('Error initializing map:', error);
                // Show error fallback
                const errorDiv = document.createElement('div');
                errorDiv.className = 'flex items-center justify-center h-96 text-red-500 bg-red-50 border border-red-200 rounded';
                errorDiv.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <div>Map could not load</div>
                        <div class="text-sm text-gray-600">Error: ${error.message}</div>
                    </div>
                `;
                mapContainer.appendChild(errorDiv);
            }
        }

        // Chat functionality
        let chatHistory = [];

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage(message, 'user');
            input.value = '';

            // Show typing indicator
            const typingMessage = addChatMessage('🤔 Analyzing current wildfire conditions...', 'ai');
            
            try {
                const response = await generateAIResponse(message);
                // Remove typing indicator
                typingMessage.remove();
                addChatMessage(response, 'ai');
            } catch (error) {
                // Remove typing indicator and show error
                typingMessage.remove();
                addChatMessage('⚠️ Sorry, I encountered an error. Please try again.', 'ai');
            }
        }

        function askQuickQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendChatMessage();
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function addChatMessage(message, sender) {
            const chatHistory = document.getElementById('chatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-2';

            if (sender === 'ai') {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <p class="text-sm text-gray-800 whitespace-pre-line">${message}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center flex-shrink-0 ml-auto">
                        <i class="fas fa-user text-white text-sm"></i>
                    </div>
                    <div class="bg-primary text-white p-3 rounded-lg shadow-sm ml-auto">
                        <p class="text-sm whitespace-pre-line">${message}</p>
                    </div>
                `;
                messageDiv.className = 'flex items-start space-x-2 justify-end';
            }

            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return messageDiv; // Return the element so it can be removed later
        }

        // Real AI API integration for chatbot responses
        async function generateAIResponse(userMessage) {
            // Get current selected ZIP data for context
            const selectedZip = selectedZipCode ? venturaZipCodes.find(zip => zip.zipCode === selectedZipCode) : null;
            const contextualData = selectedZip || { risk: currentRiskScore, temp: weatherData.temperature, humidity: weatherData.humidity, wind: weatherData.windSpeed };
            
            // Check if message is asking about specific ZIP code
            const zipCodeMatch = userMessage.match(/\b9[13]\d{3}\b/);
            let targetZip = null;
            if (zipCodeMatch) {
                targetZip = venturaZipCodes.find(zip => zip.zipCode === zipCodeMatch[0]);
            }
            
            // Build context for AI
            const context = {
                userMessage,
                currentLocation: selectedZip ? `${selectedZip.name} (${selectedZip.zipCode})` : 'Ventura County',
                currentData: contextualData,
                targetZip: targetZip || selectedZip,
                allZipCodes: venturaZipCodes,
                timestamp: new Date().toISOString()
            };
            
            try {
                // Try to use real AI API first
                const aiResponse = await callRealAI(context);
                if (aiResponse) {
                    return aiResponse;
                }
            } catch (error) {
                console.log('AI API unavailable, using intelligent fallback');
            }
            
            // Enhanced intelligent fallback with real data analysis
            return generateIntelligentFallback(context);
        }
        
        // Call real AI API (OpenAI/Anthropic)
        async function callRealAI(context) {
            const apiKey = localStorage.getItem('openai_api_key') || localStorage.getItem('anthropic_api_key');
            if (!apiKey) {
                console.log('No AI API key found');
                return null;
            }
            
            const prompt = buildWildfirePrompt(context);
            
            try {
                // Try OpenAI first
                if (localStorage.getItem('openai_api_key')) {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('openai_api_key')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o-mini',
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: 500,
                            temperature: 0.3
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.choices[0].message.content;
                    }
                }
                
                // Try Anthropic as fallback
                if (localStorage.getItem('anthropic_api_key')) {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'x-api-key': localStorage.getItem('anthropic_api_key'),
                            'Content-Type': 'application/json',
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: 'claude-3-haiku-20240307',
                            max_tokens: 500,
                            messages: [{ role: 'user', content: prompt }],
                            temperature: 0.3
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.content[0].text;
                    }
                }
            } catch (error) {
                console.error('AI API error:', error);
            }
            
            return null;
        }
        
        // Build comprehensive wildfire analysis prompt
        function buildWildfirePrompt(context) {
            const { userMessage, currentLocation, currentData, targetZip, allZipCodes } = context;
            
            return `You are a wildfire safety expert AI assistant analyzing current conditions in Ventura County, California.

CURRENT SITUATION:
- Location: ${currentLocation}
- Risk Level: ${currentData.risk}/100 (${targetZip ? targetZip.level : 'MODERATE'})
- Temperature: ${currentData.temp}°F
- Humidity: ${currentData.humidity}%
- Wind Speed: ${currentData.wind} mph
- Current Time: ${new Date().toLocaleTimeString()}

USER QUESTION: "${userMessage}"

${targetZip ? `SPECIFIC LOCATION DATA for ${targetZip.name} (${targetZip.zipCode}):
- Risk Score: ${targetZip.risk}/100 (${targetZip.level})
- Temperature: ${targetZip.temp}°F
- Humidity: ${targetZip.humidity}%
- Wind: ${targetZip.wind} mph` : ''}

AVAILABLE ZIP CODES: ${allZipCodes.map(zip => `${zip.zipCode} (${zip.name}): ${zip.risk}/100 ${zip.level}`).join(', ')}

Please provide accurate, helpful wildfire safety information based on the actual data provided. Be specific about the risk levels and conditions. If asked about evacuation or emergency situations, provide serious, actionable advice. Keep responses concise but informative.

Focus on:
1. Accurate risk assessment based on real data
2. Location-specific recommendations
3. Practical safety advice
4. Emergency preparedness if conditions warrant

Do not provide generic responses - use the actual data provided.`;
        }
        
        // Enhanced intelligent fallback with real data analysis
        function generateIntelligentFallback(context) {
            const { userMessage, currentLocation, currentData, targetZip } = context;
            const message = userMessage.toLowerCase();
            
            // Real data-driven analysis
            const analyzeCurrentConditions = (data) => {
                const conditions = [];
                const recommendations = [];
                
                if (data.temp > 90) {
                    conditions.push(`🌡️ EXTREME heat (${data.temp}°F)`);
                    recommendations.push('Avoid outdoor activities during peak hours');
                } else if (data.temp > 85) {
                    conditions.push(`🌡️ HIGH temperature (${data.temp}°F)`);
                }
                
                if (data.humidity < 15) {
                    conditions.push(`💧 CRITICALLY low humidity (${data.humidity}%)`);
                    recommendations.push('No outdoor burning - extreme fire danger');
                } else if (data.humidity < 25) {
                    conditions.push(`💧 Very low humidity (${data.humidity}%)`);
                    recommendations.push('Avoid any spark-producing activities');
                }
                
                if (data.wind > 25) {
                    conditions.push(`💨 Strong winds (${data.wind} mph)`);
                    recommendations.push('Secure outdoor items, monitor fire spread potential');
                } else if (data.wind > 15) {
                    conditions.push(`💨 Moderate winds (${data.wind} mph)`);
                }
                
                return { conditions, recommendations };
            };
            
            // Handle ZIP code specific queries
            if (message.match(/\b9[13]\d{3}\b/) || message.includes('91361')) {
                const zip91361 = venturaZipCodes.find(zip => zip.zipCode === '91361');
                if (zip91361) {
                    const analysis = analyzeCurrentConditions(zip91361);
                    return `📍 **THOUSAND OAKS (91361) CURRENT STATUS:**
                    
🔥 **Risk Level: ${zip91361.risk}/100 (${zip91361.level})**
📊 **Conditions:** ${zip91361.temp}°F, ${zip91361.humidity}% humidity, ${zip91361.wind} mph winds

${analysis.conditions.length > 0 ? `⚠️ **Key Factors:** ${analysis.conditions.join(', ')}` : '✅ **Conditions:** Generally favorable'}

${analysis.recommendations.length > 0 ? `**Recommendations:**\n• ${analysis.recommendations.join('\n• ')}` : '**Recommendations:**\n• Normal fire season precautions apply\n• Monitor conditions if planning outdoor activities'}

**Emergency Contacts:** Ventura County Fire: 911 | Non-emergency: (805) 389-9725`;
                }
            }
            
            // Current conditions query
            if (message.includes('current') && (message.includes('risk') || message.includes('conditions'))) {
                const analysis = analyzeCurrentConditions(currentData);
                const location = targetZip ? `${targetZip.name} (${targetZip.zipCode})` : currentLocation;
                
                return `📊 **${location.toUpperCase()} - LIVE CONDITIONS**

🔥 **Fire Risk:** ${currentData.risk}/100 ${targetZip ? `(${targetZip.level})` : ''}
🌡️ **Temperature:** ${currentData.temp}°F
💧 **Humidity:** ${currentData.humidity}%
💨 **Wind:** ${currentData.wind} mph

${analysis.conditions.length > 0 ? `⚠️ **Alert Factors:** ${analysis.conditions.join(', ')}` : '✅ **Status:** Conditions within normal parameters'}

${analysis.recommendations.length > 0 ? `**Action Items:**\n• ${analysis.recommendations.join('\n• ')}` : '**Standard Precautions:**\n• Maintain defensible space\n• Keep emergency kit ready\n• Monitor local alerts'}

*Last updated: ${new Date().toLocaleTimeString()}*`;
            }
            
            // Emergency/smoke queries - serious response
            if (message.includes('smoke') || message.includes('fire') || message.includes('emergency')) {
                return `🚨 **WILDFIRE EMERGENCY PROTOCOL:**

**IMMEDIATE ACTIONS:**
1. Call 911 immediately to report location
2. Evacuate if ordered or if fire is approaching
3. Follow predetermined evacuation routes
4. Stay low if smoke is present
5. Do not return for belongings

**EVACUATION ROUTES (Ventura County):**
• Primary: Highway 101 (North/South)
• Secondary: Highway 126 (East)
• Alternate: Highway 33 (North)

**EMERGENCY CONTACTS:**
• Fire/Medical Emergency: 911
• Ventura County Emergency: (805) 654-2721
• Road Conditions: 511

**CURRENT RISK ALERT:** Risk level ${currentData.risk}/100 - Monitor conditions closely`;
            }
            
            // Default helpful response
            return `🔥 **Wildfire AI Assistant**

I provide real-time wildfire risk analysis for Ventura County. Currently monitoring ${currentLocation}.

**Ask me about:**
• Current fire risk for specific ZIP codes (e.g., "91361")
• Weather conditions and fire danger
• Emergency procedures and evacuation routes
• Home protection strategies

**Current Overview:** ${currentData.risk}/100 risk level with ${currentData.temp}°F, ${currentData.humidity}% humidity, ${currentData.wind} mph winds.

*What specific information do you need?*`;
        }
        
        // API Settings Management
        function toggleApiSettings() {
            const panel = document.getElementById('apiSettings');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                // Load current values
                document.getElementById('openaiKey').value = localStorage.getItem('openai_api_key') || '';
                document.getElementById('anthropicKey').value = localStorage.getItem('anthropic_api_key') || '';
            } else {
                panel.classList.add('hidden');
            }
        }
        
        function saveApiKeys() {
            const openaiKey = document.getElementById('openaiKey').value.trim();
            const anthropicKey = document.getElementById('anthropicKey').value.trim();
            
            if (openaiKey) {
                localStorage.setItem('openai_api_key', openaiKey);
            }
            if (anthropicKey) {
                localStorage.setItem('anthropic_api_key', anthropicKey);
            }
            
            // Show confirmation
            const hasKeys = openaiKey || anthropicKey;
            const message = hasKeys 
                ? '✅ API keys saved! Real-time AI analysis is now enabled.' 
                : '⚠️ No API keys provided. Using intelligent fallback responses.';
                
            addChatMessage(message, 'ai');
            toggleApiSettings();
        }
        
        function clearApiKeys() {
            localStorage.removeItem('openai_api_key');
            localStorage.removeItem('anthropic_api_key');
            document.getElementById('openaiKey').value = '';
            document.getElementById('anthropicKey').value = '';
            
            addChatMessage('🗑️ API keys cleared. Now using intelligent fallback responses.', 'ai');
            toggleApiSettings();
        }

        // Event listeners
        document.getElementById('refreshData').addEventListener('click', refreshData);

        // Initialize dashboard on load
        document.addEventListener('DOMContentLoaded', function() {
            // Add a small delay to ensure all libraries are loaded
            setTimeout(() => {
                console.log('Initializing dashboard...');
                initializeDashboard();
                
                // Initialize map with additional delay for Leaflet
                setTimeout(() => {
                    console.log('Initializing map...');
                    initializeMap();
                }, 500);
            }, 100);
        });

        // Auto-refresh every 5 minutes
        setInterval(() => {
            refreshData();
        }, 300000);
    </script>
</body>
</html>